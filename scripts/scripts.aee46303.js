"use strict";angular.module("larutadeldinero",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/treemap.html",controller:"TreemapCtrl"}).when("/mapa",{templateUrl:"views/map.html",controller:"MapCtrl"}).when("/graficos",{templateUrl:"views/charts.html",controller:"ChartsCtrl"}).when("/tabla",{templateUrl:"views/table.html",controller:"TableCtrl"}).when("/aportante/:documento",{templateUrl:"views/aportante.html",controller:"AportanteCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location",function(a,b){a.location=b}]).controller("AppCtrl",["$scope","$rootScope","Agrupaciones",function(a,b,c){function d(){setTimeout(function(){b.$emit("filterChanged")},100)}b.filter={year:null,type:null,district:null,party:null,sexes:{},ages:{},amounts:{}},a.advancedFilterCollapsed=!1,a.years=[2007,2009,2011,2013],a.types=["PRIMARIAS","GENERALES"],a.districts=["ORDEN NACIONAL","BUENOS AIRES","CAPITAL FEDERAL","CATAMARCA","CHACO","CHUBUT","CORDOBA","CORRIENTES","ENTRE RIOS","FORMOSA","JUJUY","LA PAMPA","LA RIOJA","MENDOZA","MISIONES","NEUQUEN","RIO NEGRO","SALTA","SAN JUAN","SAN LUIS","SANTA CRUZ","SANTA FE","SANTIAGO DEL ESTERO","TIERRA DEL FUEGO","TUCUMAN"],c.findAll().then(function(a){b.parties=a.data.objects}),a.sexes=[{name:"Hombres",val:"M"},{name:"Mujeres",val:"F"}],a.ages=[{name:"Menos de 30",val:"menos de 30"},{name:"Entre 30 y 39",val:"30-39"},{name:"Entre 40 y 49",val:"40-49"},{name:"Entre 50 y 59",val:"50-59"},{name:"Entre 60 y 69",val:"60-69"},{name:"M치s de 70",val:"70 y m치s"}],a.amounts=[{name:"Menos de $500",val:"1 - $499 \n"},{name:"Entre $500 y $1.999",val:"500 - $1.999 \n"},{name:"Entre $2.000 y $4.999",val:"2.000 - $4.999 \n"},{name:"Entre $5.000 y $9.999",val:"5.000 - $9.999 \n"},{name:"Entre $10.000 y $49.999",val:"10.000 - $49.999 \n"},{name:"M치s de $50.000",val:"50.000 y m치s \n"}],setTimeout(function(){b.$watch("filter",d,!0)},1e3),a.hasAnyTrueValues=function(a){for(var b in a)if(a[b])return!0;return!1}}]).directive("preventClick",function(){return function(a,b){$(b).click(function(a){a.preventDefault()})}}).filter("agrupacionName",["$rootScope",function(a){return function(b){var c=a.parties.filter(function(a){return a.id==b});return c.length>0?c[0].nombre:"-"}}]),angular.module("larutadeldinero").controller("TreemapCtrl",["$scope",function(){}]).directive("treemap",["Aportes","$rootScope",function(a){return{restrict:"E",link:function(b,c){function d(a){a.x=a.y=0,a.dx=m,a.dy=n,a.depth=0}function e(a){return(a._children=a.children)?a.value=a.children.reduce(function(a,b){return a+e(b)},0):a.value}function f(a){a._children&&(r.nodes({_children:a._children}),a._children.forEach(function(b){b.x=a.x+b.x*a.dx,b.y=a.y+b.y*a.dy,b.dx*=a.dx,b.dy*=a.dy,b.parent=a,f(b)}))}function g(a){function c(a){if(!k&&a){k=!0,b.$apply(function(){a.parent.parent?a.parent.parent.parent?a.parent.parent.parent.parent?a.parent.parent.parent.parent.parent||(b.filter.party=a.name):b.filter.district=a.name:b.filter.type=a.name:b.filter.year=parseInt(a.name)});var c=g(a),e=d.transition().duration(750),f=c.transition().duration(750);p.domain([a.x,a.x+a.dx]),q.domain([a.y,a.y+a.dy]),s.style("shape-rendering",null),s.selectAll(".depth").sort(function(a,b){return a.depth-b.depth}),c.selectAll("text").style("fill-opacity",0),e.selectAll("text").call(h).style("fill-opacity",0),f.selectAll("text").call(h).style("fill-opacity",1),e.selectAll("rect").call(i),f.selectAll("rect").call(i),e.remove().each("end",function(){s.style("shape-rendering","crispEdges"),k=!1})}}t.datum(a.parent).on("click",c).select("text").text(j(a));var d=s.insert("g",".grandparent").datum(a).attr("class","depth"),e=d.selectAll("g").data(a._children).enter().append("g").attr("id",function(a){return"year-"+a.name});return e.filter(function(a){return a._children}).classed("children",!0).on("click",c),e.selectAll(".child").data(function(a){return a._children||[a]}).enter().append("rect").attr("class","child").call(i),e.append("rect").attr("class","parent").call(i).append("title").text(function(a){return o(a.value)}),e.append("text").attr("dy",".75em").text(function(a){return a.name}).call(h),e}function h(a){a.attr("x",function(a){return p(a.x)+6}).attr("y",function(a){return q(a.y)+6})}function i(a){a.attr("x",function(a){return p(a.x)}).attr("y",function(a){return q(a.y)}).attr("width",function(a){return p(a.x+a.dx)-p(a.x)}).attr("height",function(a){return q(a.y+a.dy)-q(a.y)})}function j(a){return a.parent?j(a.parent)+"."+a.name:a.name}var k,l={top:20,right:0,bottom:0,left:0},m=$("#main").width(),n=500-l.top-l.bottom,o=d3.format(",d"),p=d3.scale.linear().domain([0,m]).range([0,m]),q=d3.scale.linear().domain([0,n]).range([0,n]),r=d3.layout.treemap().children(function(a,b){return b?null:a._children}).sort(function(a,b){return a.value-b.value}).ratio(n/m*.5*(1+Math.sqrt(5))).round(!1),s=d3.select(c[0]).append("svg").attr("width",m+l.left+l.right).attr("height",n+l.bottom+l.top).style("margin-left",-l.left+"px").style("margin.right",-l.right+"px").append("g").attr("transform","translate("+l.left+","+l.top+")").style("shape-rendering","crispEdges"),t=s.append("g").attr("class","grandparent");t.append("rect").attr("y",-l.top).attr("width",m).attr("height",l.top),t.append("text").attr("x",6).attr("y",6-l.top).attr("dy",".75em"),a.forTreemap().then(function(a){var b=a.data;d(b),e(b),f(b),g(b)})}}}]),angular.module("larutadeldinero").controller("MapCtrl",["$scope","$http","$rootScope","Aportantes",function(a,b,c,d){a.layers=[],a.map=L.map("map",{center:[-34.5957733,-58.3814453],maxZoom:17,zoom:11,zoomControl:!1});var e='<a href="http://openstreetmap.org">OpenStreetMap</a>';L.tileLayer("http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png",{attribution:"&copy; "+e+" Contributors"}).addTo(a.map),L.control.zoom().addTo(a.map),a.center={lat:24.0391667,lng:121.525,zoom:8};var f=["868a08","386cb0","61380b","d7191c","018571","969696"],g=[];c.$on("filterChanged",function(){a.addDataToMap()}),a.addDataToMap=function(){return a.layers.length>0&&(a.layers.forEach(function(b){a.map.removeLayer(b)}),a.layers=[]),a.loading?!1:(a.loading=!0,void d.forMap().then(function(b){var c=b.data.objects.filter(function(a){return a.aportes.length>0});$(c).each(function(a,b){var c=b.aportes[0].color;g[c]||(g[c]=[]);var d=b;d.layer=f.indexOf(c);var e=d.aportes.reduce(function(a,b){return a+b.importe},0),h=new L.CircleMarker([d.lat,d.lon],{dni:d.documento,monto:e,radius:Math.log(e),fillOpacity:.8,color:"#"+c});h.l=c,g[c].push(h)});for(var e in g){var h=new L.MarkerClusterGroup({iconCreateFunction:function(a){var b=0;a.getAllChildMarkers().map(function(a){b+=parseInt(a.options.monto)});var c="1";c=5e3>b?1:2e4>b?2:5e4>b?3:1e5>b?4:5e5>b?5:6;var d=a.getAllChildMarkers()[0].l;return new L.DivIcon({html:'<div style="background-color:transparent; overflow:hidden"><div class=" circle'+c+'" style="background:#'+d+';"></div></div>'})},spiderfyDistanceMultiplier:1,showCoverageOnHover:!1,disableClusteringAtZoom:14,maxClusterRadius:80});h.on("click",function(b){var c=b.layer.options.dni;d.findById(c).then(function(d){var e=new L.Popup;e.setLatLng(b.layer._latlng);var f=d.data.objects[0],g=0;f.aportes.forEach(function(a){g+=parseInt(a.importe)});e.setContent('<div><p style="margin:0;">'+f.apellido+", "+f.nombre+'</p><p style="margin:0;">'+g+'$</p><p style="margin:0;"><a href="#/aportante/'+c+'">Ficha</a></p><div>'),a.map.openPopup(e)})});for(var i=0;i<g[e].length;i++)h.addLayer(g[e][i]);a.layers.push(h),a.map.addLayer(h),a.loading=!1}}))},a.addDataToMap()}]),angular.module("larutadeldinero").controller("ChartsCtrl",["$scope","$rootScope","Aportes",function(a,b,c){a.refreshData=function(){c.aportantesBySex().then(function(b){a.aportantesBySex=b.data.objects[0][0].values}),c.aportantesByAge().then(function(b){a.aportantesByAge=b.data.objects[0].values}),c.aportantesByAgrupacion().then(function(b){a.aportantesByAgrupacion=b.data.objects[0].values}),c.bySex().then(function(b){a.aportesBySex=b.data.objects[0].values}),c.byAge().then(function(b){a.aportesByAge=b.data.objects[0].values}),c.byAgrupacion().then(function(b){a.aportesByAgrupacion=b.data.objects[0].values})},setTimeout(function(){a.refreshData()}),b.$on("filterChanged",function(){a.refreshData()})}]).directive("barChart",["$rootScope",function(){return{restrict:"E",scope:{data:"="},link:function(a,b,c){setTimeout(function(){function d(a,b){a.each(function(){for(var a,c=d3.select(this),d=c.text().split(/\s+/).reverse(),e=[],f=0,g=1.1,h=c.attr("y"),i=parseFloat(c.attr("dy")),j=c.text(null).append("tspan").attr("x",0).attr("y",h).attr("dy",i+"em");a=d.pop();)e.push(a),j.text(e.join(" ")),j.node().getComputedTextLength()>b&&(e.pop(),j.text(e.join(" ")),e=[a],j=c.append("tspan").attr("x",0).attr("y",h).attr("dy",++f*g+i+"em").text(a))})}var e=$("#"+c.containerId).width(),f={top:20,right:20,bottom:parseInt(c.marginBottom)||30,left:40},g=e-f.left-f.right,h=c.height-f.top-f.bottom,i=c.yAxisLabel||"",j=c.yAxisMax,k=c.yAxisTicks||10,l=c.chartTitle||"",m=!1,n=d3.scale.ordinal().rangeRoundBands([0,g],.1),o=d3.scale.linear().range([h,0]),p=d3.svg.axis().scale(n).orient("bottom"),q=d3.svg.axis().scale(o).orient("left").ticks(k);c.yAxisTickFormat&&q.tickFormat(d3.format(c.yAxisTickFormat));var r=d3.select(b[0]).append("svg").attr("width",g+f.left+f.right).attr("height",h+f.top+f.bottom).append("g").attr("transform","translate("+f.left+","+f.top+")");r.append("g").attr("class","title").append("text").style("text-anchor","middle").attr("x",g/2).attr("y",-f.top/2).text(l),r.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")"),r.append("g").attr("class","y axis").append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(i),a.$watch("data",function(a){if(!a)return!1;n.domain(a.map(function(a){return a.label})),m||(o.domain([0,j||d3.max(a,function(a){return a.value})]),m=!0),r.select(".x.axis").call(p).selectAll("text").call(d,n.rangeBand()),r.select(".y.axis").call(q);var b=r.selectAll(".bar").data(a);b.enter().append("rect").attr("class","bar").attr("x",function(a){return n(a.label)}).attr("width",n.rangeBand()).attr("y",h).attr("height",0),b.attr("width",n.rangeBand()),b.transition().attr("y",function(a){return o(a.value)}).attr("height",function(a){return h-o(a.value)}),b.exit().remove()})},100)}}}]),angular.module("larutadeldinero").controller("TableCtrl",["$scope","$rootScope","Aportes",function(a,b,c){a.currentPage=1,a.maxSize=10,a.pageChanged=function(){a.fetching=!0,c.find(a.currentPage).then(function(b){a.fetching=!1,a.totalItems=b.data.num_results,a.totalPages=b.data.total_pages,a.aportes=b.data.objects})},a.filterByName=function(){a.currentPage=1,a.pageChanged()},b.$on("filterChanged",function(){a.currentPage=1,a.pageChanged()})}]),angular.module("larutadeldinero").controller("AportanteCtrl",["$scope","$routeParams","Aportantes",function(a,b,c){var d=b.documento;c.findById(d).then(function(b){a.aportante=b.data.objects[0]})}]),angular.module("larutadeldinero").factory("Aportantes",["$http","$rootScope",function(a,b){function c(a,b){var c={filters:[]};if(angular.extend(c,b),a.sexes){var d=[];for(var e in a.sexes)a.sexes[e]&&d.push(e);d.length>0&&c.filters.push({name:"sexo",op:"in",val:d})}return c}var d="http://api.larutaelectoral.com.ar/api";return{find:function(b){return a.get(d+"/aportantes?page="+b)},findById:function(b){var c={filters:[{name:"documento",op:"eq",val:b}]};return a.get(d+"/aportantes?q="+JSON.stringify(c))},forMap:function(){var e=[],f={filters:[{name:"lat",op:"neq",val:""},{name:"lon",op:"neq",val:""}]},g=c(b.filter,f);return g&&e.push("q="+JSON.stringify(g)),a.get(d+"/mapa?"+e.join("&"))}}}]).factory("Aportes",["$http","$rootScope",function(a,b){function c(a,b,c){var d=[],e=null;if(c&&(d=d.concat(c)),b&&(e={order_by:b}),a.year&&d.push({name:"ciclo",op:"eq",val:a.year}),a.type&&d.push({name:"eleccion",op:"eq",val:a.type}),a.district&&d.push({name:"distrito",op:"eq",val:a.district}),a.party&&d.push({name:"agrupacion_id",op:"eq",val:a.party.id}),a.aportanteName&&d.push({name:"aportante",op:"has",val:{name:"apellido",op:"like",val:"%"+a.aportanteName+"%"}}),a.sexes){var f=[];for(var g in a.sexes)a.sexes[g]&&f.push(g);f.length>0&&d.push({name:"aportante",op:"has",val:{name:"sexo",op:"in",val:f}})}if(a.ages){var h=[];for(var i in a.ages)a.ages[i]&&h.push(i);h.length>0&&d.push({name:"grupo_edad",op:"in",val:h})}if(a.amounts){var j=[];for(var k in a.amounts)a.amounts[k]&&j.push("$"+k);j.length>0&&d.push({name:"grupo_aporte",op:"in",val:j})}return d.length>0&&(e||(e={}),e.filters=d),e}var d="http://api.larutaelectoral.com.ar/api";return{forTreemap:function(){return a.get(d+"/treemap")},find:function(e){var f=["page="+e],g=[{field:"importe",direction:"desc"}],h=c(b.filter,g);return h&&f.push("q="+JSON.stringify(h)),a.get(d+"/aportes?"+f.join("&"))},bySex:function(){var e=[],f=c(b.filter);return f&&e.push("q="+JSON.stringify(f)),a.get(d+"/aportes/sexo?"+e.join("&"))},byAge:function(){var e=[],f=c(b.filter);return f&&e.push("q="+JSON.stringify(f)),a.get(d+"/aportes/edad?"+e.join("&"))},byAgrupacion:function(){var e=[],f=c(b.filter);return f&&e.push("q="+JSON.stringify(f)),a.get(d+"/aportes/agrupacion?"+e.join("&"))},aportantesBySex:function(){var e=[],f=c(b.filter);return f&&e.push("q="+JSON.stringify(f)),a.get(d+"/aportantes/sexo?"+e.join("&"))},aportantesByAge:function(){var e=[],f=c(b.filter);return f&&e.push("q="+JSON.stringify(f)),a.get(d+"/aportantes/edad?"+e.join("&"))},aportantesByAgrupacion:function(){var e=[],f=c(b.filter);return f&&e.push("q="+JSON.stringify(f)),a.get(d+"/aportantes/agrupacion?"+e.join("&"))}}}]).factory("Agrupaciones",["$http","$rootScope",function(a){var b="http://api.larutaelectoral.com.ar/api";return{findAll:function(){return a.get(b+"/agrupaciones?results_per_page=200")}}}]);